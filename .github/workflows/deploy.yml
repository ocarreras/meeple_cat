name: Deploy

on:
  push:
    branches: [main]

concurrency:
  group: deploy-production
  cancel-in-progress: false

env:
  REGISTRY: ghcr.io
  BACKEND_IMAGE: ghcr.io/${{ github.repository_owner }}/meeple-backend
  FRONTEND_IMAGE: ghcr.io/${{ github.repository_owner }}/meeple-frontend
  GAME_ENGINE_IMAGE: ghcr.io/${{ github.repository_owner }}/meeple-game-engine

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
      infra: ${{ steps.filter.outputs.infra }}
      game-engine: ${{ steps.filter.outputs.game-engine }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'backend/**'
            frontend:
              - 'frontend/**'
            infra:
              - 'infra/k8s/**'
            game-engine:
              - 'game-engine/**'

  test-backend:
    needs: changes
    if: needs.changes.outputs.backend == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
      - run: uv sync --extra dev
      - run: uv run pytest -v -m "not slow"

  test-frontend:
    needs: changes
    if: needs.changes.outputs.frontend == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: frontend/package-lock.json
      - run: npm ci
      - run: npx tsc --noEmit

  test-game-engine:
    needs: changes
    if: needs.changes.outputs.game-engine == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: game-engine
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - run: sudo apt-get update && sudo apt-get install -y protobuf-compiler
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: game-engine
      - run: cargo test --release

  build-backend:
    needs: [changes, test-backend]
    if: needs.changes.outputs.backend == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/setup-buildx-action@v3
      - uses: docker/build-push-action@v6
        with:
          context: ./backend
          push: true
          tags: |
            ${{ env.BACKEND_IMAGE }}:${{ github.sha }}
            ${{ env.BACKEND_IMAGE }}:latest
          cache-from: type=gha,scope=backend
          cache-to: type=gha,scope=backend,mode=max

  build-frontend:
    needs: [changes, test-frontend]
    if: needs.changes.outputs.frontend == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/setup-buildx-action@v3
      - uses: docker/build-push-action@v6
        with:
          context: ./frontend
          push: true
          tags: |
            ${{ env.FRONTEND_IMAGE }}:${{ github.sha }}
            ${{ env.FRONTEND_IMAGE }}:latest
          build-args: |
            BACKEND_URL=http://meeple-backend:8000
          cache-from: type=gha,scope=frontend
          cache-to: type=gha,scope=frontend,mode=max

  build-game-engine:
    needs: [changes, test-game-engine]
    if: needs.changes.outputs.game-engine == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/setup-buildx-action@v3
      - uses: docker/build-push-action@v6
        with:
          context: ./game-engine
          push: true
          tags: |
            ${{ env.GAME_ENGINE_IMAGE }}:${{ github.sha }}
            ${{ env.GAME_ENGINE_IMAGE }}:latest
          cache-from: type=gha,scope=game-engine
          cache-to: type=gha,scope=game-engine,mode=max

  deploy:
    needs: [changes, build-backend, build-frontend, build-game-engine]
    # Run if anything changed â€” skipped builds are treated as successful
    if: always() && !failure() && !cancelled() && (needs.changes.outputs.backend == 'true' || needs.changes.outputs.frontend == 'true' || needs.changes.outputs.infra == 'true' || needs.changes.outputs.game-engine == 'true')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG_DATA }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - uses: azure/setup-helm@v4

      - name: Decode prod values
        run: echo "${{ secrets.HELM_VALUES_PROD }}" | base64 -d > /tmp/values-prod.yaml

      - name: Resolve image tags
        id: images
        run: |
          # Use new SHA tag if that image was built, otherwise keep the currently deployed image
          if [ "${{ needs.changes.outputs.backend }}" == "true" ]; then
            echo "backend_tag=${{ github.sha }}" >> "$GITHUB_OUTPUT"
          else
            CURRENT=$(kubectl -n meeple get deployment meeple-backend -o jsonpath='{.spec.template.spec.containers[0].image}' 2>/dev/null || echo "")
            if [ -n "$CURRENT" ]; then
              echo "backend_tag=${CURRENT##*:}" >> "$GITHUB_OUTPUT"
            else
              echo "backend_tag=latest" >> "$GITHUB_OUTPUT"
            fi
          fi
          if [ "${{ needs.changes.outputs.frontend }}" == "true" ]; then
            echo "frontend_tag=${{ github.sha }}" >> "$GITHUB_OUTPUT"
          else
            CURRENT=$(kubectl -n meeple get deployment meeple-frontend -o jsonpath='{.spec.template.spec.containers[0].image}' 2>/dev/null || echo "")
            if [ -n "$CURRENT" ]; then
              echo "frontend_tag=${CURRENT##*:}" >> "$GITHUB_OUTPUT"
            else
              echo "frontend_tag=latest" >> "$GITHUB_OUTPUT"
            fi
          fi
          if [ "${{ needs.changes.outputs.game-engine }}" == "true" ]; then
            echo "game_engine_tag=${{ github.sha }}" >> "$GITHUB_OUTPUT"
          else
            CURRENT=$(kubectl -n meeple get deployment meeple-game-engine -o jsonpath='{.spec.template.spec.containers[0].image}' 2>/dev/null || echo "")
            if [ -n "$CURRENT" ]; then
              echo "game_engine_tag=${CURRENT##*:}" >> "$GITHUB_OUTPUT"
            else
              echo "game_engine_tag=latest" >> "$GITHUB_OUTPUT"
            fi
          fi

      - name: Helm upgrade
        run: |
          helm upgrade --install meeple ./infra/k8s/meeple \
            --namespace meeple --create-namespace \
            -f ./infra/k8s/meeple/values.yaml \
            -f /tmp/values-prod.yaml \
            --set backend.image=${{ env.BACKEND_IMAGE }}:${{ steps.images.outputs.backend_tag }} \
            --set frontend.image=${{ env.FRONTEND_IMAGE }}:${{ steps.images.outputs.frontend_tag }} \
            --set gameEngine.image=${{ env.GAME_ENGINE_IMAGE }}:${{ steps.images.outputs.game_engine_tag }} \
            --wait --timeout 5m

      - name: Verify rollout
        run: |
          if [ "${{ needs.changes.outputs.backend }}" == "true" ]; then
            kubectl -n meeple rollout status deployment/meeple-backend --timeout=120s
          fi
          if [ "${{ needs.changes.outputs.frontend }}" == "true" ]; then
            kubectl -n meeple rollout status deployment/meeple-frontend --timeout=120s
          fi
          if [ "${{ needs.changes.outputs.game-engine }}" == "true" ]; then
            kubectl -n meeple rollout status deployment/meeple-game-engine --timeout=120s || true
          fi

      - name: Cleanup
        if: always()
        run: rm -f /tmp/values-prod.yaml
